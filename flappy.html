<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bƒ±yƒ±klƒ±fbƒ± ‚Äî Flappy Bird (Ses + Leaderboard + Silme)</title>
<style>
  :root{
    --bg: linear-gradient(#70c5ce,#7bd3e0);
    --card-bg:#a0e0e8;
    --panel:rgba(255,255,255,0.92);
    --btn:#2d8a3b;
    --text:#073642;
  }
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
  .wrap{display:flex;align-items:flex-start;justify-content:center;gap:20px;padding:20px;box-sizing:border-box;min-height:100vh;}
  #gameCard{width:100%;max-width:420px;border-radius:12px;overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,0.2);background:var(--card-bg);position:relative;}
  canvas{display:block;width:100%;height:auto;background:transparent;}
  .hud{position:absolute;left:12px;top:10px;z-index:10;color:var(--text);font-weight:700;text-shadow:0 1px 0 rgba(255,255,255,0.5);}
  .centerOverlay{position:absolute;left:0;right:0;top:0;bottom:0;display:flex;align-items:center;justify-content:center;z-index:20;pointer-events:none;}
  .panel{background:var(--panel);color:var(--text);padding:18px 20px;border-radius:10px;text-align:center;pointer-events:auto;box-shadow:0 6px 18px rgba(0,0,0,0.12);width:90%;max-width:320px;}
  .panel h2{margin:0 0 8px;font-size:20px;}
  .panel p{margin:8px 0 12px;font-size:14px;color:#055;}
  .btn{display:inline-block;background:var(--btn);color:white;padding:8px 12px;border-radius:8px;cursor:pointer;text-decoration:none;font-weight:700;border:none;}
  .small{font-size:12px;color:#055;margin-top:6px;}
  #leaderboard{width:300px;max-width:30vw;min-width:220px;background:var(--panel);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.12);height:fit-content;}
  .scoreRow{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(0,0,0,0.06);font-weight:600;align-items:center;gap:8px;}
  .deleteBtn{background:#b22222;padding:4px 8px;border-radius:6px;color:#fff;border:none;cursor:pointer;font-weight:700;font-size:12px;}
  @media (max-width:900px){ .wrap{flex-direction:column;align-items:center;} #leaderboard{width:92%;max-width:420px;} }
</style>
</head>
<body>
<div class="wrap">
  <div id="gameCard" role="application" aria-label="Flappy Bird oyunu">
    <canvas id="game"></canvas>

    <div class="hud" id="hudScore">Skor: 0</div>

    <div class="centerOverlay" id="overlayStart">
      <div class="panel" id="startPanel">
        <h2>Flappy Bƒ±yƒ±klƒ±fbƒ±</h2>
        <p>Dokun, tƒ±kla ya da bo≈üluk tu≈üuna basarak ku≈üu zƒ±plat. Borulara √ßarpma!</p>
        <div style="display:flex;gap:8px;justify-content:center;">
          <button class="btn" id="startBtn">Oyunu Ba≈ülat</button>
          <button class="btn" id="toggleSpriteBtn">Sprite Kullan</button>
        </div>
        <p class="small">En y√ºksek skor (yerel): <span id="bestBefore">0</span></p>
      </div>
    </div>

    <div class="centerOverlay" id="overlayGameOver" style="display:none">
      <div class="panel" id="overPanel">
        <h2>Oyun Bitti</h2>
        <p>Skorunuz: <strong id="finalScore">0</strong></p>
        <p class="small">En y√ºksek (yerel): <strong id="finalBest">0</strong></p>
        <div style="margin-top:10px;text-align:left;">
          <label for="nameInput">Skor kaydetmek i√ßin isim:</label>
          <input id="nameInput" type="text" placeholder="ƒ∞sminiz (kƒ±sa)" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);box-sizing:border-box;margin-top:6px;" />
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button class="btn" id="submitScoreBtn">Skoru Kaydet</button>
            <button class="btn" id="restartBtn">Tekrar Oyna</button>
          </div>
          <p class="small">Kaydedilen skorlar global leaderboard'a gider. Kendi skorlarƒ±nƒ± silebilirsin.</p>
        </div>
      </div>
    </div>

  </div>

  <div id="leaderboard" aria-live="polite">
    <h3>üèÜ Top 10 Leaderboard</h3>
    <div id="scoresList"><div style="text-align:center;color:#666;padding:8px 0;">Y√ºkleniyor...</div></div>
    <div style="margin-top:10px;">
      <div style="font-size:13px;color:#055;">En y√ºksek (global): <strong id="globalTop">0</strong></div>
      <div class="small">ƒ∞simle g√∂nder ve toplulukta rekabet et!</div>
    </div>
    <div style="margin-top:12px;font-weight:700;">üîê Benim Skorlarƒ±m</div>
    <div id="myScoresList" style="margin-top:8px;"><div style="text-align:center;color:#666;padding:8px 0;">Y√ºkleniyor...</div></div>
  </div>
</div>

<div style="text-align:center;padding:12px;color:#043;font-size:12px;">Kontroller: dokun / tƒ±k / bo≈üluk. ƒ∞yi oyunlar!</div>

<script type="module">
/* Full working flappy with Firebase leaderboard + delete (fixed & completed) */

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, push, onValue, query, orderByChild, limitToLast, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

/* ---------- firebase config ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCNC1M0tgiKdV-YbE-zPrES2MP0oXN0xLU",
  authDomain: "byklfb-c85d8.firebaseapp.com",
  databaseURL: "https://byklfb-c85d8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "byklfb-c85d8",
  storageBucket: "byklfb-c85d8.appspot.com",
  messagingSenderId: "115753196341",
  appId: "1:115753196341:web:53eda190794a6e4b7e4a7c",
  measurementId: "G-6GRY9LN4LE"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------- DOM ---------- */
const canvas = document.getElementById('game');
const card = document.getElementById('gameCard');
const ctx = canvas.getContext('2d', { alpha: true });
const hudScore = document.getElementById('hudScore');
const overlayStart = document.getElementById('overlayStart');
const overlayGameOver = document.getElementById('overlayGameOver');
const startBtn = document.getElementById('startBtn');
const restartBtn = document.getElementById('restartBtn');
const bestBefore = document.getElementById('bestBefore');
const finalScore = document.getElementById('finalScore');
const finalBest = document.getElementById('finalBest');
const nameInput = document.getElementById('nameInput');
const submitScoreBtn = document.getElementById('submitScoreBtn');
const scoresList = document.getElementById('scoresList');
const globalTopEl = document.getElementById('globalTop');
const toggleSpriteBtn = document.getElementById('toggleSpriteBtn');
const myScoresList = document.getElementById('myScoresList');

/* ---------- local id & best ---------- */
let userId = localStorage.getItem('biyik_userId');
if(!userId){ userId = (crypto && crypto.randomUUID)? crypto.randomUUID() : ('uid_'+Date.now()+'_'+Math.floor(Math.random()*10000)); localStorage.setItem('biyik_userId', userId); }
const STORAGE_KEY_LOCAL = 'biyik_flappy_best';
let bestLocal = parseInt(localStorage.getItem(STORAGE_KEY_LOCAL) || '0', 10);
bestBefore.textContent = bestLocal;

/* ---------- canvas scale ---------- */
const BASE_W = 400, BASE_H = 600;
function fitCanvas(){
  const rect = card.getBoundingClientRect();
  const scale = Math.min(rect.width / BASE_W, (rect.height || window.innerHeight) / BASE_H) || rect.width/BASE_W;
  const pixelW = Math.round(BASE_W * scale);
  const pixelH = Math.round(BASE_H * scale);
  const dpr = window.devicePixelRatio || 1;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = Math.round(rect.width * (BASE_H/BASE_W)) + 'px';
  canvas.width = pixelW * dpr;
  canvas.height = pixelH * dpr;
  ctx.setTransform(dpr * (pixelW/BASE_W), 0, 0, dpr * (pixelH/BASE_H), 0, 0);
}
window.addEventListener('resize', fitCanvas);
fitCanvas();

/* ---------- game params ---------- */
const BIRD_RADIUS = 12;
const GRAVITY = 1000;
const FLAP_V = -320;
const PIPE_W = 60;
const GAP_MIN = 140;
const GAP_MAX = 200;
const PIPE_SPACING = 180;
const PIPE_SPEED = 140;
const GROUND_H = 90;

/* ---------- state ---------- */
let state = 'idle';
let bird = { x: BASE_W*0.28, y: BASE_H*0.5, vy:0, rot:0 };
let pipes = [];
let score = 0;
let lastTs = 0;
let useSprite = false;

/* ---------- sprite ---------- */
const birdSVG = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><g><circle cx='60' cy='60' r='28' fill='#ffdd57' stroke='#f2c94c' stroke-width='2'/><ellipse cx='56' cy='68' rx='22' ry='14' fill='#ffd86b'/><circle cx='74' cy='52' r='5' fill='#222'/><polygon points='82,60 98,56 98,66' fill='#ff9d3c' /></g></svg>`);
const spriteImg = new Image(); spriteImg.src = `data:image/svg+xml;charset=utf-8,${birdSVG}`;

/* ---------- audio ---------- */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new AudioCtx(); }
function tryUnlockAudio(){ try{ if(!audioCtx) audioCtx = new AudioCtx(); if(audioCtx && audioCtx.state==='suspended') audioCtx.resume().catch(()=>{}); }catch(e){} }
function playFlap(){ try{ ensureAudio(); const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='triangle'; o.frequency.value=600; g.gain.value=0.0001; o.connect(g); g.connect(audioCtx.destination); const now=audioCtx.currentTime; g.gain.setValueAtTime(0.0001,now); g.gain.exponentialRampToValueAtTime(0.12,now+0.01); g.gain.exponentialRampToValueAtTime(0.0001,now+0.25); o.start(now); o.stop(now+0.26);}catch(e){} }
function playPoint(){ try{ ensureAudio(); const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.0001; o.connect(g); g.connect(audioCtx.destination); const now=audioCtx.currentTime; g.gain.exponentialRampToValueAtTime(0.12,now+0.01); g.gain.exponentialRampToValueAtTime(0.0001,now+0.22); o.start(now); o.stop(now+0.26);}catch(e){} }
function playHit(){ try{ ensureAudio(); const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sawtooth'; o.frequency.value=120; g.gain.value=0.0001; o.connect(g); g.connect(audioCtx.destination); const now=audioCtx.currentTime; g.gain.exponentialRampToValueAtTime(0.18,now+0.01); g.gain.exponentialRampToValueAtTime(0.0001,now+0.6); o.start(now); o.stop(now+0.65);}catch(e){} }

/* ---------- helpers ---------- */
function escapeHtml(str){ return String(str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;"); }

/* ---------- core game ---------- */
function resetGame(){
  state = 'running';
  bird = { x: BASE_W * 0.28, y: BASE_H * 0.5, vy: 0, rot: 0 };
  pipes = [];
  score = 0;
  hudScore.textContent = 'Skor: 0';
  overlayStart.style.display = 'none';
  overlayGameOver.style.display = 'none';
  lastTs = performance.now();
  for(let i=0;i<3;i++){
    const x = BASE_W + i * PIPE_SPACING + 60;
    const gap = Math.round(Math.random() * (GAP_MAX - GAP_MIN) + GAP_MIN);
    const gapY = Math.round(Math.random() * (BASE_H - 140 - gap - 80) + 80);
    pipes.push({ x, gapY, gap, passed:false });
  }
  try{ if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }catch(e){}
  requestAnimationFrame(loop);
}

function gameOver(){
  state = 'over';
  overlayGameOver.style.display = 'flex';
  finalScore.textContent = score;
  if(score > bestLocal){ bestLocal = score; localStorage.setItem(STORAGE_KEY_LOCAL, String(bestLocal)); }
  finalBest.textContent = bestLocal;
  bestBefore.textContent = bestLocal;
  playHit();
}

function circleRectCollide(cx, cy, r, rx, ry, rw, rh){
  const nearestX = Math.max(rx, Math.min(cx, rx+rw));
  const nearestY = Math.max(ry, Math.min(cy, ry+rh));
  const dx = cx - nearestX, dy = cy - nearestY;
  return (dx*dx + dy*dy) < (r*r);
}

function flap(){
  tryUnlockAudio();
  if(state === 'idle'){ resetGame(); bird.vy = FLAP_V; playFlap(); return; }
  if(state !== 'running') return;
  bird.vy = FLAP_V; bird.rot = -0.5; playFlap();
}

/* inputs */
window.addEventListener('keydown', (e) => { if(e.code === 'Space' || e.code === 'ArrowUp'){ e.preventDefault(); flap(); } });
canvas.addEventListener('pointerdown', (e) => { flap(); });

toggleSpriteBtn && toggleSpriteBtn.addEventListener('click', ()=>{
  useSprite = !useSprite;
  toggleSpriteBtn.textContent = useSprite ? 'Sprite Kullanƒ±lƒ±yor ‚úÖ' : 'Sprite Kullan';
});

/* main loop */
function loop(ts){
  if(state !== 'running') return;
  const dt = Math.min(0.05, (ts - lastTs) / 1000);
  lastTs = ts;
  update(dt);
  render();
  requestAnimationFrame(loop);
}

function update(dt){
  bird.vy += GRAVITY * dt;
  bird.y += bird.vy * dt;
  bird.rot += ((bird.vy / 600) - bird.rot) * 8 * dt;

  for(const p of pipes){
    p.x -= PIPE_SPEED * dt;
    if(!p.passed && p.x + PIPE_W < bird.x - BIRD_RADIUS){
      p.passed = true; score += 1; hudScore.textContent = 'Skor: ' + score; playPoint();
    }
  }
  if(pipes.length && pipes[0].x + PIPE_W < -50) pipes.shift();

  if(pipes.length === 0 || (BASE_W - (pipes[pipes.length-1].x) ) > PIPE_SPACING - 20 ){
    const x = (pipes.length? pipes[pipes.length-1].x : BASE_W) + PIPE_SPACING;
    const gap = Math.round(Math.random() * (GAP_MAX - GAP_MIN) + GAP_MIN);
    const gapY = Math.round(Math.random() * (BASE_H - 140 - gap - 80) + 80);
    pipes.push({ x, gapY, gap, passed:false });
  }

  if(bird.y - BIRD_RADIUS < 0 || bird.y + BIRD_RADIUS > BASE_H - GROUND_H){ gameOver(); return; }
  for(const p of pipes){
    if(circleRectCollide(bird.x, bird.y, BIRD_RADIUS, p.x, 0, PIPE_W, p.gapY)){ gameOver(); return; }
    const bottomY = p.gapY + p.gap;
    if(circleRectCollide(bird.x, bird.y, BIRD_RADIUS, p.x, bottomY, PIPE_W, BASE_H - GROUND_H - bottomY)){ gameOver(); return; }
  }
}

/* rendering */
function render(){
  ctx.clearRect(0,0,BASE_W,BASE_H);
  const g = ctx.createLinearGradient(0,0,0,BASE_H); g.addColorStop(0,'#70c5ce'); g.addColorStop(1,'#7bd3e0');
  ctx.fillStyle = g; ctx.fillRect(0,0,BASE_W,BASE_H);
  for(const p of pipes){
    ctx.fillStyle = '#2d8a3b'; ctx.fillRect(Math.round(p.x), 0, PIPE_W, p.gapY);
    const bottomY = p.gapY + p.gap; ctx.fillRect(Math.round(p.x), bottomY, PIPE_W, BASE_H - GROUND_H - bottomY);
    ctx.fillStyle = '#236a2c'; ctx.fillRect(Math.round(p.x)-6, Math.round(p.gapY)-12, PIPE_W+12, 12); ctx.fillRect(Math.round(p.x)-6, Math.round(bottomY), PIPE_W+12, 12);
  }
  ctx.fillStyle = '#c19a57'; ctx.fillRect(0, BASE_H - GROUND_H, BASE_W, GROUND_H);
  ctx.strokeStyle = 'rgba(0,0,0,0.06)'; for(let gx=0; gx<BASE_W; gx+=20){ ctx.beginPath(); ctx.moveTo(gx, BASE_H-40); ctx.lineTo(gx+10, BASE_H-90); ctx.stroke(); }

  ctx.save(); ctx.translate(bird.x, bird.y); ctx.rotate(bird.rot);
  if(useSprite && spriteImg.complete){ const w = BIRD_RADIUS*3.3, h = BIRD_RADIUS*3.3; ctx.drawImage(spriteImg, -w/2, -h/2, w, h); }
  else {
    ctx.beginPath(); ctx.fillStyle = '#ffdd57'; ctx.arc(0,0,BIRD_RADIUS,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.fillStyle='#ffd86b'; ctx.ellipse(-2,4,BIRD_RADIUS*0.9,BIRD_RADIUS*0.6,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.fillStyle='#222'; ctx.arc(6,-3,3,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.fillStyle='#ff9d3c'; ctx.moveTo(BIRD_RADIUS-2,0); ctx.lineTo(BIRD_RADIUS+12,-3); ctx.lineTo(BIRD_RADIUS+12,4); ctx.closePath(); ctx.fill();
  }
  ctx.restore();
  ctx.fillStyle = 'rgba(255,255,255,0.55)'; ctx.font = '700 34px system-ui, Arial'; ctx.textAlign='center';
  ctx.fillText(score, BASE_W*0.5, 58);
}

/* initial idle render */
function renderIdle(){ render(); }
renderIdle();
overlayStart.style.display = 'flex';

/* ---------- Leaderboard: Firebase RTDB integration ---------- */
const scoresRef = ref(db, 'flappy_scores');
const topQuery = query(scoresRef, orderByChild('score'), limitToLast(10));
onValue(topQuery, snapshot => {
  const val = snapshot.val() || {};
  const arr = Object.entries(val).map(([k,v]) => ({ key:k, ...v }));
  arr.sort((a,b)=> b.score - a.score);
  if(arr.length === 0){
    if(scoresList) scoresList.innerHTML = '<div style="text-align:center;color:#666;padding:8px 0;">Hen√ºz skor yok.</div>';
    if(globalTopEl) globalTopEl.textContent = '0';
    return;
  }
  const rows = arr.map((s, idx) => {
    const displayName = escapeHtml(s.name || 'Anonim').slice(0,18);
    const delBtn = (s.userId && s.userId === userId) ? `<button class="deleteBtn" data-key="${s.key}">Sil</button>` : '';
    return `<div class="scoreRow" data-key="${s.key}"><div style="flex:1">${idx+1}. ${displayName}</div><div style="min-width:60px;text-align:right">${s.score}</div><div>${delBtn}</div></div>`;
  }).join('');
  if(scoresList) scoresList.innerHTML = rows;
  if(globalTopEl) globalTopEl.textContent = arr[0].score;

  document.querySelectorAll('#scoresList .deleteBtn').forEach(btn=>{
    btn.onclick = () => {
      const key = btn.dataset.key;
      if(!confirm('Bu skoru silmek istediƒüinizden emin misiniz?')) return;
      remove(ref(db, 'flappy_scores/' + key)).then(()=> { alert('Skor silindi.'); }).catch(err=> { console.error('silme hata', err); alert('Skor silinirken hata.'); });
    };
  });
});

onValue(scoresRef, snapshot => {
  const val = snapshot.val() || {};
  const arr = Object.entries(val).map(([k,v]) => ({ key:k, ...v }));
  const my = arr.filter(s => s.userId && s.userId === userId).sort((a,b)=> b.score - a.score);
  if(my.length === 0){
    if(myScoresList) myScoresList.innerHTML = '<div style="text-align:center;color:#666;padding:8px 0;">Hen√ºz kayƒ±tlƒ± skorun yok.</div>';
    return;
  }
  if(myScoresList) myScoresList.innerHTML = my.map(s => {
    const displayName = escapeHtml(s.name || 'Anonim').slice(0,18);
    return `<div class="scoreRow"><div style="flex:1">${displayName}</div><div style="min-width:60px;text-align:right">${s.score}</div><div><button class="deleteBtn myDel" data-key="${s.key}">Sil</button></div></div>`;
  }).join('');

  document.querySelectorAll('#myScoresList .myDel').forEach(btn=>{
    btn.onclick = () => {
      const key = btn.dataset.key;
      if(!confirm('Bu kaydƒ± (sadece sizin kaydƒ±nƒ±z) silmek istediƒüinizden emin misiniz?')) return;
      remove(ref(db, 'flappy_scores/' + key)).then(()=> { alert('Skor kaydƒ± silindi.'); }).catch(err=>{ console.error('silme hata', err); alert('Silme ba≈üarƒ±sƒ±z.'); });
    };
  });
});

/* submit score (include userId) */
function submitScoreToFirebase(name, scoreVal){
  if(!name) name = 'Anonim';
  push(scoresRef, { name: name.slice(0,24), score: scoreVal, ts: Date.now(), userId })
    .then(()=> {})
    .catch(err => { console.error('score push err', err); alert('Skor kaydedilemedi.'); });
}

/* form actions (completed) */
submitScoreBtn && submitScoreBtn.addEventListener('click', ()=>{
  const nm = (nameInput.value || '').trim();
  if(score <= 0){
    alert('Skor 0 iken kayƒ±t yapƒ±lamaz.');
    return;
  }
  if(nm) localStorage.setItem('biyik_player_name', nm);
  submitScoreToFirebase(nm || 'Anonim', score);
  submitScoreBtn.textContent = 'Kaydedildi ‚úì';
  setTimeout(()=> submitScoreBtn.textContent = 'Skoru Kaydet', 1400);
});

/* prefill name */
const savedName = localStorage.getItem('biyik_player_name') || '';
if(nameInput) nameInput.value = savedName;

/* Start button wiring & fallbacks */
(function wireStartButtons(){
  if (startBtn) {
    startBtn.addEventListener('click', (e) => { e.preventDefault(); tryUnlockAudio(); resetGame(); });
  }
  const overlay = document.getElementById('overlayStart');
  if (overlay) {
    overlay.addEventListener('pointerdown', (e) => {
      if (e.target === overlay) { tryUnlockAudio(); resetGame(); }
    });
  }
  if (restartBtn) restartBtn.addEventListener('click', (e)=>{ e.preventDefault(); tryUnlockAudio(); resetGame(); });
})();

/* Unlock audio on first gesture to avoid blocked audio on mobile/Chrome */
document.addEventListener('pointerdown', tryUnlockAudio, { once:true, passive:true });

/* small global error handler for debugging */
window.addEventListener('error', (ev) => { console.error('[FLAPPY GLOBAL ERROR]', ev.message, ev.filename, ev.lineno); });

/* nudge canvas sizing after layout */
setTimeout(()=>{ try{ window.dispatchEvent(new Event('resize')); }catch(e){} }, 300);
</script>
</body>
</html>
